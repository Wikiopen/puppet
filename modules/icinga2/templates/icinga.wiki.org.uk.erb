server {
	listen 80;
	listen [::]:80;

	server_name icinga.wiki.org.uk;
    root /usr/share/icingaweb2/public;

	include /etc/acme/challenge-nginx.conf;

	location / {
		return 301 https://icinga.wiki.org.uk$request_uri;
	}
}

server {
	listen 443 ssl http2;
	listen [::]:443 ssl http2;

	server_name icinga.wiki.org.uk;
    root /usr/share/icingaweb2/public;

	ssl_certificate /etc/acme/cert/icinga.chained.crt;
	ssl_certificate_key /etc/acme/key/icinga.key;
	ssl_trusted_certificate /etc/acme/cert/icinga.chained.crt;

	# ssl_trusted_certificate /etc/ssl/certs/GlobalSign.crt;

	# add_header Strict-Transport-Security "max-age=15768000; includeSubDomains; preload";
	
    location ~ ^/icingaweb2(.+)? {
      alias /usr/share/icingaweb2/public;
      index index.php
      try_files $1 $uri $uri/ /icingaweb2/index.php$is_args$args;
    }

  location ~ ^/icingaweb2/index\.php(.*)$ {
    fastcgi_index index.php;
    include       /etc/nginx/fastcgi_params;
    fastcgi_pass  unix:/var/run/php/php7.1-fpm.sock;
    fastcgi_param SCRIPT_FILENAME     /usr/share/icingaweb2/public/index.php;
    fastcgi_param ICINGAWEB_CONFIGDIR /etc/icingaweb2;
  }
}
